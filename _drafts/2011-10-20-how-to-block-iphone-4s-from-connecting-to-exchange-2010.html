---
layout: post
title: How to Block iPhone 4S from Connecting to Exchange 2010
date: 2011-10-20 11:36:29.000000000 +11:00
type: post
published: true
status: publish
categories:
- Technology
tags:
- Annoyances
- Apple
- Automation
- Exchange
- Hacks
- iPhone
- iPhone 4S
- Scripting
- Security
- Siri
- tips
meta:
  _jd_tweet_this: 'yes'
  _jd_twitter: ''
  _wp_jd_clig: ''
  _wp_jd_bitly: ''
  _wp_jd_wp: ''
  _wp_jd_yourls: ''
  _wp_jd_url: ''
  _wp_jd_target: ''
  _jd_wp_twitter: ''
  _jd_post_meta_fixed: 'true'
  _edit_last: '1'
  robotsmeta: index,follow
  Hide SexyBookmarks: '0'
  Hide OgTags: '0'
  dsq_thread_id: '448216036'
  _syntaxhighlighter_encoded: '1'
author:
  login: chris
  email: chris@flamingkeys.com
  display_name: Chris
  first_name: Chris
  last_name: Brown
excerpt: With the inherent flaws (AKA features) offered by Apple’s new iPhone 4S with
  Siri, you may be required to block it from accessing your Exchange server via ActiveSync..
  Here's how!
---
<h3></h3>
<h3>Siri, Tell Me About The Problem</h3>
<p>With the <a href="http://www.theage.com.au/it-pro/security-it/iphone-4s-security-hole-uncovered-20111019-1m6xt.html">inherent</a> <a href="http://nakedsecurity.sophos.com/2011/10/19/siri-iphone-4s-unlocked/">flaws</a> (AKA features) offered by Apple’s new iPhone 4S with <em><a href="http://www.apple.com/iphone/features/siri.html">Siri</a></em>, I was asked to block access to our ActiveSync services from 4S devices. Unfortunately, Exchange’s Device Access Rules don’t allow us to drill any further down than “iPhone” (Honestly I think this is the fault of Apple for not reporting device model correctly..but that’s just me).</p>
<p><a href="https://www.flamingkeys.com/wp-content/uploads/2011/10/image.png"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="image" src="{{ site.baseurl }}/assets/image_thumb.png" alt="image" width="244" height="105" border="0" /></a></p>
<p>In my environment (and most others, no doubt), “Sorry, Exchange can’t do that” isn’t really good enough, so extra troubleshooting was required. I decided to jump into Exchange Management Shell (EMS) and check out any more properties I could find. Issuing the <em>Get-ActiveSyncDevice | Out-Gridview</em> Exchange command yielded some useful results (some details removed from the graphic to protect the guilty). I’ve included all the properties that contain any information of use in blocking the devices. The property of particular interest is <em>DeviceUserAgent</em>. This seems to show some consistency, in that all iPhones are in the format “Apple-iPhone<em><span style="color: #0000ff;">x</span></em>C1”. <em><span style="color: #0000ff;">x</span></em> seems to be an incremented number that increases with device revisions.</p>
<p><a href="https://www.flamingkeys.com/wp-content/uploads/2011/10/image1.png"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="image" src="{{ site.baseurl }}/assets/image_thumb1.png" alt="image" width="244" height="90" border="0" /></a></p>
<p>By doing some user to model to Operating System spot-checks (and thanks to some helpful people on Twitter!) I was able to ascertain that <em>DeviceUserAgent </em>directly correlates to the hardware of the device connecting to Exchange (not necessarily the version of the iOS build, as was my initial fear). The <em>DeviceUserAgent </em>for the iPhone 4 is Apple-iPhone3C1, and the iPhone 4S is Apple-iPhone4C1. Knowing this, I can now update my filter to show only iPhone 4S devices (that is, where the DeviceUserAgent begins with “Apple-iPhone4C1/”:</p>
<p><a href="https://www.flamingkeys.com/wp-content/uploads/2011/10/image2.png"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="image" src="{{ site.baseurl }}/assets/image_thumb2.png" alt="image" width="244" height="48" border="0" /></a></p>
<p>It appears that the string following the slash (/) in the <em>DeviceUserAgent</em> may relate to the iOS build on the device, but this isn’t really relevant at this stage. If Apple start to offer Siri (and this security hole) on previous versions of the hardware, I may need to adjust the queries to suit.</p>
<h3>TLDR; Siri, Just Tell Me How to Nuke You!</h3>
<p>Dependent on your organisational policies, you may be able to take the <a href="http://support.apple.com/kb/DL1465">easy way out</a> in blocking Siri on the iPhone 4S. Unfortunately, we run a <a href="http://www.zdnet.com/debate/great-debate-bring-your-own-device/6313019">BYOD</a> environment for most staff who want to, and we take a completely hands-off approach on this (no support, no assistance beyond “these are your settings”). For this reason, I’ve decided the easiest approach (since Device Access Rules aren’t going to work for me here) is to write a script that simply removes any connections to these  devices every time it runs. I’ll leave the frequency up to you to decide. The one line script looks like this:</p>
<p>[ps]Get-ActiveSyncDevice –filter { DeviceUserAgent –like “Apple-iPhone4C1/*”} | Remove-ActiveSyncDevice –Confirm:$false[/ps]</p>
<p>What does this do?</p>
<table width="400" border="0" cellspacing="0" cellpadding="2">
<tbody>
<tr>
<td valign="top" width="200"><strong>Command Segment</strong></td>
<td valign="top" width="200"><strong>Description</strong></td>
</tr>
<tr>
<td valign="top" width="200">Get-ActiveSyncDevice</td>
<td valign="top" width="200">Get an array of all the ActiveSync Devices</td>
</tr>
<tr>
<td valign="top" width="200">-filter { }</td>
<td valign="top" width="200">Only return devices whose DeviceUserAgent begins with “Apple-iPhone4C1/”</td>
</tr>
<tr>
<td valign="top" width="200">Remove-ActiveSyncDevice</td>
<td valign="top" width="200">Remove the devices</td>
</tr>
<tr>
<td valign="top" width="200">-confirm:$false</td>
<td valign="top" width="200">Don’t prompt for confirmation (we want this to be automated!)</td>
</tr>
</tbody>
</table>
<p><span style="color: #c0504d;"><strong>Keep in mind any typos here could be devastating, so make sure you only add the –confirm:$false argument once you’ve tested and confirmed this works for you.</strong></span></p>
<p>After running this script, I sat content that iPhone 4S devices would would be blocked from my Exchange environment. However it occurred to me over lunch, whilst eating my quiche, that devices could simply re-join themselves to Exchange! On to plan B (Well.. Plan A, part 2):</p>
<p>Within IIS, it’s a relatively trivial task to block host headers. On your CAS servers, ensure you have the role feature ‘Request Filtering’ installed for IIS. This will allow you to do some very cool filtering dependent on a number of parameters. (Edit: Belated hat tip to <a href="http://twitter.com/jamesbannan" target="_blank">@jamesbannan</a> for the IIS idea)</p>
<p><a href="https://www.flamingkeys.com/wp-content/uploads/2011/10/image3.png"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="image" src="{{ site.baseurl }}/assets/image_thumb3.png" alt="image" width="244" height="117" border="0" /></a></p>
<p>Jump into IIS Manager and drill down as far as you’d like. I did this at the server level; I don’t want 4S devices accessing anything! You could easily do this on just your OWA site, or even further down the tree.</p>
<p>Under <em>IIS</em>, select <em>Request Filtering</em>. On the <em>Rules</em> tab, select <em>Add Filtering Rule</em>. Enter a descriptive name, then under <em>Scan Headers</em> enter a new line “User-Agent”. This will tell IIS to check the “User-Agent” component of all request headers. Leave “Applies To” empty, so it will apply to all file types. Under “Deny Strings”, enter the user agent of the iPhone 4S (“Apple-iPhone4C1/*”). You could theoretically block any user agents you want to here (*cough*Android*cough*). My rule looks like this:</p>
<p><a href="https://www.flamingkeys.com/wp-content/uploads/2011/10/image4.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="image" src="{{ site.baseurl }}/assets/image_thumb4.png" alt="image" width="176" height="244" border="0" /></a></p>
<p>When browsing from a device with the host header specified above (i.e. the iPhone 4S), IIS will return this beautiful error message:</p>
<p><a href="https://www.flamingkeys.com/wp-content/uploads/2011/10/image5.png"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="image" src="{{ site.baseurl }}/assets/image_thumb5.png" alt="image" width="244" height="84" border="0" /></a></p>
<p>When browsing from an allowed device (say, an iPhone 4):</p>
<p><a href="https://www.flamingkeys.com/wp-content/uploads/2011/10/image6.png"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border-width: 0px;" title="image" src="{{ site.baseurl }}/assets/image_thumb6.png" alt="image" width="244" height="207" border="0" /></a></p>
<p>&nbsp;</p>
<p>Hopefully Apple will remedy this flaw soon so that we can stop with this workaround. It’s irresponsible of a software manufacturer to release such a hole...but that’s an argument for another blog post by someone much smarter than me.</p>
